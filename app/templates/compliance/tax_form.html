{% extends "base.html" %}

{% block title %}{{ 'Editar' if record else 'Nuevo' }} Impuesto - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-currency-euro"></i> {{ 'Editar' if record else 'Nuevo' }} Registro de Impuesto</h1>
    </div>
</div>

<div class="card">
    <div class="card-body">
    <form method="POST" action="{{ url_for('compliance.create_tax') if not record else url_for('compliance.edit_tax', tax_id=record.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="vehicle_id" class="form-label">Vehículo *</label>
                        <select class="form-select" id="vehicle_id" name="vehicle_id" required>
                            <option value="">Seleccionar vehículo...</option>
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.id }}" {% if record and record.vehicle_id == vehicle.id %}selected{% endif %}>
                                {{ vehicle.license_plate }} - {{ vehicle.brand }} {{ vehicle.model }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="tax_type" class="form-label">Tipo de Impuesto *</label>
                        <select class="form-select" id="tax_type" name="tax_type" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="ivtm" {% if record and record.tax_type.value == 'ivtm' %}selected{% endif %}>IVTM (Impuesto de Vehículos)</option>
                            <option value="otro" {% if record and record.tax_type.value == 'otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="tax_year" class="form-label">Año Fiscal *</label>
                        <input type="number" class="form-control" id="tax_year" name="tax_year" 
                               value="{{ record.tax_year if record else datetime.now().year }}" 
                               min="2000" max="2100" required>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Importe (€) *</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" 
                               value="{{ record.amount if record else '' }}" placeholder="0.00" required>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="due_date" class="form-label">Fecha de Vencimiento *</label>
                        <input type="date" class="form-control" id="due_date" name="due_date" 
                               value="{{ record.due_date.strftime('%Y-%m-%d') if record else '' }}" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="payment_status" class="form-label">Estado de Pago *</label>
                        <select class="form-select" id="payment_status" name="payment_status" required>
                            <option value="pendiente" {% if record and record.payment_status.value == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="pagado" {% if record and record.payment_status.value == 'pagado' %}selected{% endif %}>Pagado</option>
                            <option value="con_retraso" {% if record and record.payment_status.value == 'con_retraso' %}selected{% endif %}>Vencido</option>
                            <option value="exento" {% if record and record.payment_status.value == 'exento' %}selected{% endif %}>Exento</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Fecha de Pago</label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" 
                               value="{{ record.payment_date.strftime('%Y-%m-%d') if record and record.payment_date else '' }}">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Método de Pago</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="">No especificado</option>
                            <option value="bank_transfer" {% if record and record.payment_method == 'bank_transfer' %}selected{% endif %}>Transferencia Bancaria</option>
                            <option value="card" {% if record and record.payment_method == 'card' %}selected{% endif %}>Tarjeta</option>
                            <option value="cash" {% if record and record.payment_method == 'cash' %}selected{% endif %}>Efectivo</option>
                            <option value="direct_debit" {% if record and record.payment_method == 'direct_debit' %}selected{% endif %}>Domiciliación</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="payment_reference" class="form-label">Referencia de Pago</label>
                        <input type="text" class="form-control" id="payment_reference" name="payment_reference" 
                               value="{{ record.payment_reference if record else '' }}" placeholder="Número de referencia o recibo">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Notas</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" 
                          placeholder="Observaciones adicionales...">{{ record.notes if record else '' }}</textarea>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('compliance.tax_records') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> {{ 'Actualizar' if record else 'Guardar' }} Registro
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
