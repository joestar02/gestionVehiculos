{% extends "base.html" %}

{% block title %}{{ 'Editar' if organization else 'Nueva' }} Organización - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="bi bi-building"></i> {{ 'Editar Organización' if organization else 'Nueva Organización' }}</h1>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Nombre *</label>
                    <input type="text" class="form-control" id="name" name="name" 
                           value="{{ organization.name if organization else '' }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="code" class="form-label">Código *</label>
                    <input type="text" class="form-control" id="code" name="code" 
                           value="{{ organization.code if organization else '' }}" 
                           {{ 'readonly' if organization else '' }} required>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descripción</label>
                <textarea class="form-control" id="description" name="description" rows="3">{{ organization.description if organization else '' }}</textarea>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="manager_name" class="form-label">Nombre del Responsable</label>
                    <input type="text" class="form-control" id="manager_name" name="manager_name" 
                           value="{{ organization.manager_name if organization else '' }}">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="parent_id" class="form-label">Organización Padre</label>
                    <div class="input-group mb-2">
                        <input type="text" id="search-org" class="form-control" placeholder="Buscar organización...">
                    </div>
                    <div id="org-tree" class="jstree-proton-container" style="min-height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        <!-- Tree will be loaded here -->
                    </div>
                    <input type="hidden" id="parent_id" name="parent_id" value="{{ organization.parent_id if organization else '' }}">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="contact_email" class="form-label">Email de Contacto</label>
                    <input type="email" class="form-control" id="contact_email" name="contact_email" 
                           value="{{ organization.contact_email if organization else '' }}">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="contact_phone" class="form-label">Teléfono de Contacto</label>
                    <input type="tel" class="form-control" id="contact_phone" name="contact_phone" 
                           value="{{ organization.contact_phone if organization else '' }}">
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('organizations.list_organizations') }}" class="btn btn-junta-secondary">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-junta-primary">
                    <i class="bi bi-save"></i> {{ 'Actualizar' if organization else 'Crear' }} Organización
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- jsTree Proton Theme CSS - Latest version -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.9.0/dist/themes/proton/style.min.css" />
<style>
/* Container for the tree */
.jstree-proton-container {
    display: block;
    width: 100%;
    background-color: #ffffff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Ensure proton theme applies to the tree */
.jstree-proton-container .jstree {
    background-color: #ffffff;
    color: #2c3e50;
    font-size: 14px;
}

.jstree-proton-container .jstree-anchor {
    line-height: 24px;
    color: #2c3e50;
}

.jstree-proton-container .jstree-anchor:hover {
    background-color: #f1f5fd;
}

.jstree-proton-container .jstree-clicked {
    background-color: #e0eafc;
}

.jstree-proton-container .jstree-wholerow-clicked {
    background-color: #e0eafc;
}

/* Icon sizing */
.jstree-proton-container .jstree-icon {
    width: 20px;
    height: 20px;
}

/* Proper spacing */
.jstree-proton-container .jstree-ul {
    padding-left: 18px;
}

.jstree-proton-container .jstree-text {
    color: #2c3e50;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jstree@3.9.0/dist/jstree.min.js"></script>
<script>
$(document).ready(function() {
    // Prepare the tree data
    var treeData = [
        {
            'id': 'none',
            'parent': '#',
            'text': 'Ninguna (Nivel superior)',
            'icon': true
        }
    ];

    {% for org in organizations %}
    {% if not organization or org.id != organization.id %}
    treeData.push({
        'id': '{{ org.id }}',
        'parent': '{{ org.parent_id if org.parent_id else 'none' }}',
        'text': '{{ org.name }}',
        'icon': true
    });
    {% endif %}
    {% endfor %}

    // Initialize the jstree with proton theme
    $('#org-tree').jstree({
        'core': {
            'data': treeData,
            'check_callback': true,
            'multiple': false,
            'themes': {
                'name': 'proton',
                'responsive': true,
                'dots': true,
                'icons': true,
                'stripes': false
            }
        },
        'plugins': ['wholerow', 'search']
    });

    // Set the parent selection on ready
    $('#org-tree').on('ready.jstree', function() {
        var tree = $(this).jstree(true);
        var selectedParentId = $('#parent_id').val();
        
        if (selectedParentId) {
            tree.select_node(selectedParentId);
        } else {
            tree.select_node('none');
        }
        
        tree.open_all();
    });

    // Handle node selection
    $('#org-tree').on('select_node.jstree', function(e, data) {
        var node = data.node;
        $('#parent_id').val(node.id === 'none' ? '' : node.id);
    });

    // Search functionality
    var searchTimeout = false;
    var searchValue = '';
    
    $('#search-org').keyup(function() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        searchValue = $(this).val();
        
        if (searchValue.length === 0) {
            $('#org-tree').jstree(true).clear_search();
        } else {
            searchTimeout = setTimeout(function() {
                $('#org-tree').jstree(true).search(searchValue);
            }, 250);
        }
    });

    // Clear search on button clear
    $('#search-org').on('input', function() {
        if (!$(this).val()) {
            $('#org-tree').jstree(true).clear_search();
        }
    });
});
</script>
{% endblock %}

    // Apply the proton theme class directly to the container
    $('#org-tree').addClass('jstree-proton');

    // Set the parent selection on ready
    $('#org-tree').on('ready.jstree', function() {
        var tree = $(this).jstree(true);
        var selectedParentId = $('#parent_id').val();
        
        if (selectedParentId) {
            tree.select_node(selectedParentId);
        } else {
            tree.select_node('none');
        }
        
        tree.open_all();
    });

    // Handle node selection
    $('#org-tree').on('select_node.jstree', function(e, data) {
        var node = data.node;
        $('#parent_id').val(node.id === 'none' ? '' : node.id);
    });

    // Search functionality
    var searchTimeout = false;
    var searchValue = '';
    
    $('#search-org').keyup(function() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        searchValue = $(this).val();
        
        if (searchValue.length === 0) {
            $('#org-tree').jstree(true).clear_search();
        } else {
            searchTimeout = setTimeout(function() {
                $('#org-tree').jstree(true).search(searchValue);
            }, 250);
        }
    });

    // Clear search on button clear (if using Bootstrap clear button)
    $('#search-org').on('input', function() {
        if (!$(this).val()) {
            $('#org-tree').jstree(true).clear_search();
        }
    });
});
</script>
{% endblock %}
